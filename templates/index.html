<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NSE Ratio Terminal</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%);
            color: #e0e0e0;
            font-family: Arial, sans-serif;
            min-height: 100vh;
        }

        /* NEON TITLE */
        @keyframes pulse-title {
            0%, 100% { text-shadow: 0 0 10px rgba(0, 255, 255, 0.5), 0 0 20px rgba(255, 0, 255, 0.5); }
            50% { text-shadow: 0 0 30px rgba(0, 255, 255, 0.8), 0 0 50px rgba(255, 0, 255, 0.8), 0 0 70px rgba(255, 255, 255, 0.5); }
        }

        @keyframes pulse-bolt {
            from { text-shadow: 0 0 10px #00ffff, 0 0 20px #00ffff; opacity: 0.8; }
            to { text-shadow: 0 0 20px #00ffff, 0 0 40px #00ffff, 0 0 60px #fff; opacity: 1; }
        }

        .neon-container {
            display: flex;
            justify-content: flex-start;
            align-items: center;
            padding: 40px 20px;
            gap: 20px;
            background: radial-gradient(circle at top left, rgba(20,20,20,0.8) 0%, rgba(0,0,0,0) 70%);
        }

        .neon-text {
            font-family: 'Orbitron', sans-serif;
            font-size: 3.5vw;
            font-weight: 900;
            text-transform: uppercase;
            background: linear-gradient(90deg, #00ffff, #ff00ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: pulse-title 3s infinite;
            letter-spacing: 2px;
        }

        .neon-bolt {
            font-size: 3.5vw;
            color: #00ffff;
            animation: pulse-bolt 1.5s infinite alternate;
        }

        .header-dart {
            font-size: 3vw;
        }

        /* TABS */
        .tabs {
            display: flex;
            gap: 25px;
            padding: 30px 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .tab-button {
            background: #121212;
            border-radius: 12px;
            padding: 15px 30px;
            font-size: 22px;
            font-weight: 800;
            border: 2px solid #333;
            font-family: 'Orbitron', sans-serif;
            box-shadow: 0 4px 6px rgba(0,0,0,0.5);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            position: relative;
        }

        .tab-button:hover {
            transform: translateY(-3px) scale(1.02);
            background: #1e1e1e;
        }

        .tab-button.active {
            box-shadow: 0 0 25px;
        }

        .tab-button:nth-child(1) { color: #39ff14; border-bottom: 4px solid #39ff14; }
        .tab-button:nth-child(1):hover { box-shadow: 0 0 20px rgba(57, 255, 20, 0.4); text-shadow: 0 0 8px #39ff14; }
        .tab-button:nth-child(1).active { background: linear-gradient(180deg, rgba(57, 255, 20, 0.1), transparent); border-color: #39ff14; box-shadow: 0 0 25px rgba(57, 255, 20, 0.6); color: #fff; text-shadow: 0 0 10px #39ff14; }

        .tab-button:nth-child(2) { color: #ff6600; border-bottom: 4px solid #ff6600; }
        .tab-button:nth-child(2):hover { box-shadow: 0 0 20px rgba(255, 102, 0, 0.4); text-shadow: 0 0 8px #ff6600; }
        .tab-button:nth-child(2).active { background: linear-gradient(180deg, rgba(255, 102, 0, 0.1), transparent); border-color: #ff6600; box-shadow: 0 0 25px rgba(255, 102, 0, 0.6); color: #fff; text-shadow: 0 0 10px #ff6600; }

        .tab-button:nth-child(3) { color: #bc13fe; border-bottom: 4px solid #bc13fe; }
        .tab-button:nth-child(3):hover { box-shadow: 0 0 20px rgba(188, 19, 254, 0.4); text-shadow: 0 0 8px #bc13fe; }
        .tab-button:nth-child(3).active { background: linear-gradient(180deg, rgba(188, 19, 254, 0.1), transparent); border-color: #bc13fe; box-shadow: 0 0 25px rgba(188, 19, 254, 0.6); color: #fff; text-shadow: 0 0 10px #bc13fe; }

        .tab-button:nth-child(4) { color: #00ffff; border-bottom: 4px solid #00ffff; }
        .tab-button:nth-child(4):hover { box-shadow: 0 0 20px rgba(0, 255, 255, 0.4); text-shadow: 0 0 8px #00ffff; }
        .tab-button:nth-child(4).active { background: linear-gradient(180deg, rgba(0, 255, 255, 0.1), transparent); border-color: #00ffff; box-shadow: 0 0 25px rgba(0, 255, 255, 0.6); color: #fff; text-shadow: 0 0 10px #00ffff; }

        .tab-button:nth-child(5) { color: #ff1493; border-bottom: 4px solid #ff1493; }
        .tab-button:nth-child(5):hover { box-shadow: 0 0 20px rgba(255, 20, 147, 0.4); text-shadow: 0 0 8px #ff1493; }
        .tab-button:nth-child(5).active { background: linear-gradient(180deg, rgba(255, 20, 147, 0.1), transparent); border-color: #ff1493; box-shadow: 0 0 25px rgba(255, 20, 147, 0.6); color: #fff; text-shadow: 0 0 10px #ff1493; }

        .tab-content {
            display: none;
            padding: 20px;
        }

        .tab-content.active {
            display: block;
        }

        /* Chart Container */
        .chart-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 30px;
            margin-bottom: 30px;
        }

        .chart-section {
            background: rgba(18, 18, 18, 0.8);
            border: 1px solid #333;
            border-radius: 12px;
            padding: 20px;
        }

        .controls {
            display: grid;
            grid-template-columns: 1.5fr 2fr 2fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .control-group label {
            font-size: 14px;
            color: #aaa;
            font-weight: 600;
        }

        select, input {
            background: #1a1a1a;
            color: #e0e0e0;
            border: 1px solid #444;
            border-radius: 6px;
            padding: 10px;
            font-size: 14px;
            font-family: Arial, sans-serif;
        }

        select:focus, input:focus {
            outline: none;
            border-color: #00ffff;
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.3);
        }

        .multi-select {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            background: #1a1a1a;
            border: 1px solid #444;
            border-radius: 6px;
            padding: 10px;
            min-height: 45px;
        }

        .multi-select-option {
            background: #00ffff;
            color: #000;
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .multi-select-option:hover {
            background: #00cccc;
        }

        .multi-select-dropdown {
            position: relative;
        }

        .dropdown-options {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: #1a1a1a;
            border: 1px solid #444;
            border-radius: 6px;
            margin-top: 5px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .dropdown-options.show {
            display: block;
        }

        .dropdown-option {
            padding: 10px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .dropdown-option:hover {
            background: #2a2a2a;
        }

        .dropdown-option.selected {
            background: #00ffff22;
            color: #00ffff;
        }

        /* Table Styles */
        .table-container {
            max-height: 900px;
            overflow: auto;
            border: 1px solid #333;
            border-radius: 8px;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }

        .custom-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            font-size: 15px;
            background-color: #121212;
            color: #e0e0e0;
        }

        .custom-table thead {
            background-color: #1a1a1a;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .custom-table th {
            padding: 15px 10px;
            text-align: center;
            border-bottom: 2px solid #ff00ff;
            border-right: 1px solid #333;
            font-size: 14px;
            cursor: pointer;
            user-select: none;
            font-family: 'Orbitron', sans-serif;
            background: linear-gradient(90deg, #ff00ff, #8b00ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            transition: all 0.2s ease;
        }

        .custom-table th:hover {
            background-color: #252525;
            transform: scale(1.02);
        }

        .custom-table th.sortable::after {
            content: ' ‚áÖ';
            color: #ffcc00;
            font-size: 12px;
        }

        .custom-table th.sort-asc::after {
            content: ' ‚ñ≤';
            color: #00f260;
        }

        .custom-table th.sort-desc::after {
            content: ' ‚ñº';
            color: #ff4d4d;
        }

        .custom-table td {
            padding: 12px 8px;
            text-align: center;
            border-bottom: 1px solid #333;
            border-right: 1px solid #333;
            font-size: 14px;
        }

        .custom-table th.left-align,
        .custom-table td.left-align {
            text-align: left !important;
            padding-left: 20px !important;
        }

        .custom-table tbody tr:hover {
            background-color: #1f1f1f;
            box-shadow: inset 0 0 10px rgba(255, 255, 255, 0.05);
        }

        .table-container::-webkit-scrollbar {
            width: 12px;
            height: 12px;
        }

        .table-container::-webkit-scrollbar-track {
            background: #121212;
        }

        .table-container::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, #ff00ff, #8b00ff);
            border-radius: 6px;
            border: 2px solid #121212;
        }

        .table-container::-webkit-scrollbar-thumb:hover {
            background: #ff00ff;
        }

        .neon-header-wrapper {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            padding-bottom: 10px;
            font-family: 'Orbitron', sans-serif;
            font-size: 28px;
            font-weight: 700;
            text-align: center;
        }

        .border-gold { border-bottom: 1px solid rgba(255, 215, 0, 0.3); }
        .border-blue { border-bottom: 1px solid rgba(0, 255, 255, 0.3); }
        .border-lime { border-bottom: 1px solid rgba(57, 255, 20, 0.3); }

        .neon-text-gold {
            background: linear-gradient(90deg, #FFD700, #FFA500);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .neon-text-blue {
            background: linear-gradient(90deg, #00ffff, #0099ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .neon-text-lime {
            background: linear-gradient(90deg, #39ff14, #32cd32);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        button {
            background: linear-gradient(135deg, #00ffff, #0099ff);
            color: #000;
            border: none;
            border-radius: 8px;
            padding: 15px 30px;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            font-family: 'Orbitron', sans-serif;
            box-shadow: 0 4px 15px rgba(0, 255, 255, 0.4);
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 255, 255, 0.6);
        }

        button:active {
            transform: translateY(0);
        }

        .loading {
            text-align: center;
            padding: 40px;
            font-size: 18px;
            color: #00ffff;
        }

        .scanner-controls {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .footer {
            text-align: center;
            padding: 30px;
            color: #888;
            font-size: 14px;
        }

        @media (max-width: 1024px) {
            .chart-grid {
                grid-template-columns: 1fr;
            }
            .neon-text {
                font-size: 5vw;
            }
        }
    </style>
</head>
<body>
    <div class="neon-container">
        <span class="header-dart">üéØ</span>
        <span class="neon-bolt">‚ö°</span>
        <div class="neon-text">RATIO ANALYSIS DASHBOARD</div>
        <span class="neon-bolt">‚ö°</span>
    </div>

    <div class="tabs">
        <button class="tab-button active" onclick="switchTab(0)">üìà Market Ratios</button>
        <button class="tab-button" onclick="switchTab(1)">üè≠ Sector Ratios</button>
        <button class="tab-button" onclick="switchTab(2)">üìä Analytics Table</button>
        <button class="tab-button" onclick="switchTab(3)">üìü Technical Dashboard</button>
        <button class="tab-button" onclick="switchTab(4)">üîç Opportunity Scanner</button>
    </div>

    <!-- TAB 1: Market Ratios -->
    <div class="tab-content active" id="tab-0">
        <div class="chart-grid" id="market-charts"></div>
    </div>

    <!-- TAB 2: Sector Ratios -->
    <div class="tab-content" id="tab-1">
        <div class="chart-grid" id="sector-charts"></div>
    </div>

    <!-- TAB 3: Analytics -->
    <div class="tab-content" id="tab-2">
        <div class="neon-header-wrapper border-gold">
            <span>üìä</span>
            <span class="neon-text-gold">Relative Strength Analytics</span>
        </div>
        <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 10px; color: #aaa;">Select Base Index</label>
            <select id="analytics-base" onchange="loadAnalytics()">
                {% for symbol in symbols %}
                <option value="{{ symbol }}" {% if symbol == 'NIFTY 500' %}selected{% endif %}>{{ symbol }}</option>
                {% endfor %}
            </select>
        </div>
        <div id="analytics-table"></div>
    </div>

    <!-- TAB 4: Technical -->
    <div class="tab-content" id="tab-3">
        <div class="neon-header-wrapper border-blue">
            <span>üìü</span>
            <span class="neon-text-blue">Multi-Timeframe Technical Dashboard</span>
        </div>
        <div id="technical-table"></div>
    </div>

    <!-- TAB 5: Scanner -->
    <div class="tab-content" id="tab-4">
        <div class="neon-header-wrapper border-lime">
            <span>üîç</span>
            <span class="neon-text-lime">Opportunity Scanner</span>
        </div>
        <div class="scanner-controls">
            <button onclick="runScanner()" style="width: 100%;">RUN HIGHLIGHT SCAN</button>
            <div>
                <label style="display: block; margin-bottom: 10px; color: #aaa;">Benchmark for RS Check</label>
                <select id="scanner-base">
                    {% for symbol in symbols %}
                    <option value="{{ symbol }}" {% if symbol == 'NIFTY 500' %}selected{% endif %}>{{ symbol }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
        <div id="scanner-results"></div>
    </div>

    <div class="footer">
        Made with ‚ù§Ô∏è by <b>Stallions</b> | ¬©2026 Stallions - All Rights Reserved
    </div>

    <script>
        const symbols = {{ symbols|tojson }};
        
        function switchTab(index) {
            document.querySelectorAll('.tab-button').forEach((btn, i) => {
                btn.classList.toggle('active', i === index);
            });
            document.querySelectorAll('.tab-content').forEach((content, i) => {
                content.classList.toggle('active', i === index);
            });

            // Load data when switching to specific tabs
            if (index === 2 && !document.querySelector('#analytics-table').innerHTML) {
                loadAnalytics();
            }
            if (index === 3 && !document.querySelector('#technical-table').innerHTML) {
                loadTechnical();
            }
        }

        // Initialize Market Charts
        function initMarketCharts() {
            const defaults = ['NIFTY 50', 'NIFTY NEXT 50', 'NIFTY 100', 'NIFTY 200'];
            const container = document.getElementById('market-charts');
            
            defaults.forEach((symbol, index) => {
                createChartSection(container, symbol, 'NIFTY 500', `market-${index}`);
            });
        }

        // Initialize Sector Charts
        function initSectorCharts() {
            const defaults = ['NIFTY BANK', 'NIFTY AUTO', 'NIFTY IT', 'NIFTY PHARMA'];
            const container = document.getElementById('sector-charts');
            
            defaults.forEach((symbol, index) => {
                createChartSection(container, symbol, 'NIFTY 500', `sector-${index}`);
            });
        }

        function createChartSection(container, defaultNum, defaultDen, id) {
            const section = document.createElement('div');
            section.className = 'chart-section';
            section.innerHTML = `
                <div class="controls">
                    <div class="control-group">
                        <label>RS Period</label>
                        <div class="multi-select-dropdown">
                            <div class="multi-select" id="${id}-rs-display" onclick="toggleRSDropdown('${id}')">
                                <span class="multi-select-option" data-value="252">252</span>
                            </div>
                            <div class="dropdown-options" id="${id}-rs-dropdown">
                                <div class="dropdown-option selected" data-value="252" onclick="toggleRSOption('${id}', 252)">252</div>
                                <div class="dropdown-option" data-value="126" onclick="toggleRSOption('${id}', 126)">126</div>
                                <div class="dropdown-option" data-value="63" onclick="toggleRSOption('${id}', 63)">63</div>
                                <div class="dropdown-option" data-value="21" onclick="toggleRSOption('${id}', 21)">21</div>
                            </div>
                        </div>
                    </div>
                    <div class="control-group">
                        <label>Numerator</label>
                        <select id="${id}-num" onchange="updateChart('${id}')">
                            ${symbols.map(s => `<option value="${s}" ${s === defaultNum ? 'selected' : ''}>${s}</option>`).join('')}
                        </select>
                    </div>
                    <div class="control-group">
                        <label>Benchmark</label>
                        <select id="${id}-den" onchange="updateChart('${id}')">
                            ${symbols.map(s => `<option value="${s}" ${s === defaultDen ? 'selected' : ''}>${s}</option>`).join('')}
                        </select>
                    </div>
                </div>
                <div id="${id}-chart" style="min-height: 600px;"></div>
            `;
            container.appendChild(section);
            
            // Initialize with data
            updateChart(id);
        }

        const rsSelections = {};

        function toggleRSDropdown(id) {
            const dropdown = document.getElementById(`${id}-rs-dropdown`);
            dropdown.classList.toggle('show');
        }

        function toggleRSOption(id, value) {
            if (!rsSelections[id]) rsSelections[id] = [252];
            
            const index = rsSelections[id].indexOf(value);
            if (index > -1) {
                rsSelections[id].splice(index, 1);
            } else {
                rsSelections[id].push(value);
            }
            
            // Update display
            const display = document.getElementById(`${id}-rs-display`);
            display.innerHTML = rsSelections[id].length > 0 
                ? rsSelections[id].map(v => `<span class="multi-select-option" data-value="${v}">${v}</span>`).join('')
                : '<span style="color: #888;">Select periods...</span>';
            
            // Update dropdown selections
            document.querySelectorAll(`#${id}-rs-dropdown .dropdown-option`).forEach(opt => {
                const val = parseInt(opt.dataset.value);
                opt.classList.toggle('selected', rsSelections[id].includes(val));
            });
            
            updateChart(id);
        }

        async function updateChart(id) {
            const num = document.getElementById(`${id}-num`).value;
            const den = document.getElementById(`${id}-den`).value;
            const rs_periods = rsSelections[id] || [252];
            
            const chartDiv = document.getElementById(`${id}-chart`);
            chartDiv.innerHTML = '<div class="loading">Loading chart...</div>';
            
            try {
                const response = await fetch('/api/plot_ratio', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ numerator: num, denominator: den, rs_periods })
                });
                
                const data = await response.json();
                if (data.error) {
                    chartDiv.innerHTML = `<div class="loading" style="color: #ff4d4d;">${data.error}</div>`;
                    return;
                }
                
                const plotData = JSON.parse(data.plot);
                Plotly.newPlot(chartDiv, plotData.data, plotData.layout, {responsive: true});
            } catch (error) {
                chartDiv.innerHTML = `<div class="loading" style="color: #ff4d4d;">Error loading chart</div>`;
            }
        }

        async function loadAnalytics() {
            const base = document.getElementById('analytics-base').value;
            const container = document.getElementById('analytics-table');
            container.innerHTML = '<div class="loading">Loading analytics data...</div>';
            
            try {
                const response = await fetch('/api/analytics', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ base_name: base })
                });
                
                const result = await response.json();
                if (result.error) {
                    container.innerHTML = `<div class="loading" style="color: #ff4d4d;">${result.error}</div>`;
                    return;
                }
                
                container.innerHTML = generateTable(result.data, ['Symbol', 'Industry'], 'analytics');
            } catch (error) {
                container.innerHTML = '<div class="loading" style="color: #ff4d4d;">Error loading data</div>';
            }
        }

        async function loadTechnical() {
            const container = document.getElementById('technical-table');
            container.innerHTML = '<div class="loading">Loading technical data...</div>';
            
            try {
                const response = await fetch('/api/technical');
                const result = await response.json();
                
                if (result.error) {
                    container.innerHTML = `<div class="loading" style="color: #ff4d4d;">${result.error}</div>`;
                    return;
                }
                
                container.innerHTML = generateTable(result.data, ['Name', 'Industry'], 'technical');
            } catch (error) {
                container.innerHTML = '<div class="loading" style="color: #ff4d4d;">Error loading data</div>';
            }
        }

        async function runScanner() {
            const base = document.getElementById('scanner-base').value;
            const container = document.getElementById('scanner-results');
            container.innerHTML = '<div class="loading">Scanning for opportunities...</div>';
            
            try {
                const response = await fetch('/api/scanner', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ base })
                });
                
                const result = await response.json();
                
                if (result.error) {
                    container.innerHTML = `<div class="loading" style="color: #ff4d4d;">${result.error}</div>`;
                    return;
                }
                
                if (result.data.length === 0) {
                    container.innerHTML = '<div class="loading" style="color: #ffcc00;">No opportunities found matching strict criteria.</div>';
                    return;
                }
                
                container.innerHTML = `
                    <div style="color: #00ff99; font-size: 18px; margin-bottom: 20px; text-align: center;">
                        ‚úì Found ${result.data.length} Opportunities!
                    </div>
                    ${generateTable(result.data, ['Symbol', 'Industry'], 'scanner')}
                `;
            } catch (error) {
                container.innerHTML = '<div class="loading" style="color: #ff4d4d;">Error running scanner</div>';
            }
        }

        function generateTable(data, leftAlignCols, tableId) {
            if (!data || data.length === 0) return '<div class="loading">No data available</div>';
            
            const columns = Object.keys(data[0]);
            
            let html = '<div class="table-container"><table class="custom-table" id="' + tableId + '"><thead><tr>';
            
            columns.forEach((col, idx) => {
                const alignClass = leftAlignCols.includes(col) ? 'left-align' : '';
                html += `<th class="sortable ${alignClass}" onclick="sortTable('${tableId}', ${idx})">${col}</th>`;
            });
            
            html += '</tr></thead><tbody>';
            
            data.forEach(row => {
                html += '<tr>';
                columns.forEach(col => {
                    const alignClass = leftAlignCols.includes(col) ? 'left-align' : '';
                    let value = row[col];
                    let color = '';
                    let cellValue = value;
                    
                    if (value === null || value === undefined || value === '-') {
                        cellValue = '-999999999';
                        value = '-';
                    } else if (col === 'Trend') {
                        if (value === 'Bullish') color = 'style="color: #00ff99; font-weight: bold;"';
                        else if (value === 'Bearish') color = 'style="color: #ff4d4d; font-weight: bold;"';
                    } else if (col === 'Above 100' || col === 'Above 200') {
                        if (value === 'Yes') {
                            color = 'style="color: #00ff99;"';
                            cellValue = '1';
                        } else if (value === 'No') {
                            color = 'style="color: #ff4d4d;"';
                            cellValue = '0';
                        }
                    } else if (col === 'Status') {
                        if (value === 'STRONG BUY') color = 'style="color: #00ff99; font-weight: bold;"';
                    } else if (col.startsWith('RS ')) {
                        if (typeof value === 'number') {
                            color = `style="color: ${value > 0 ? '#00ff99' : '#ff4d4d'};"`;
                            value = value.toFixed(2);
                            cellValue = value;
                        }
                    } else if (col.startsWith('EMA ') || col.startsWith('RSI ')) {
                        if (typeof value === 'number') {
                            const ltp = row['LTP'] || 0;
                            if (col.startsWith('EMA ')) {
                                color = `style="color: ${ltp > value ? '#00ff99' : '#ff4d4d'};"`;
                            } else {
                                color = `style="color: ${value >= 50 ? '#00ff99' : '#ff4d4d'};"`;
                            }
                            value = value.toFixed(2);
                            cellValue = value;
                        }
                    } else if (col === 'SL No.' || col === 'No') {
                        if (typeof value === 'number') {
                            value = Math.floor(value);
                            cellValue = value;
                        }
                    } else if ((col === 'LTP' || col === 'Ratio') && typeof value === 'number') {
                        value = value.toFixed(2);
                        cellValue = value;
                    }
                    
                    html += `<td class="${alignClass}" ${color} data-value="${cellValue}">${value}</td>`;
                });
                html += '</tr>';
            });
            
            html += '</tbody></table></div>';
            return html;
        }

        function sortTable(tableId, columnIndex) {
            const table = document.getElementById(tableId);
            const tbody = table.querySelector('tbody');
            const rows = Array.from(tbody.querySelectorAll('tr'));
            const header = table.querySelectorAll('th')[columnIndex];
            
            let isAscending = true;
            if (header.classList.contains('sort-asc')) {
                isAscending = false;
            }
            
            table.querySelectorAll('th').forEach(th => {
                th.classList.remove('sort-asc', 'sort-desc');
            });
            
            if (isAscending) {
                header.classList.add('sort-asc');
            } else {
                header.classList.add('sort-desc');
            }
            
            rows.sort((a, b) => {
                const aValue = a.querySelectorAll('td')[columnIndex].getAttribute('data-value');
                const bValue = b.querySelectorAll('td')[columnIndex].getAttribute('data-value');
                
                const aNum = parseFloat(aValue);
                const bNum = parseFloat(bValue);
                
                if (!isNaN(aNum) && !isNaN(bNum)) {
                    return isAscending ? aNum - bNum : bNum - aNum;
                }
                
                if (isAscending) {
                    return aValue.localeCompare(bValue);
                } else {
                    return bValue.localeCompare(aValue);
                }
            });
            
            rows.forEach(row => tbody.appendChild(row));
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            if (!event.target.closest('.multi-select-dropdown')) {
                document.querySelectorAll('.dropdown-options').forEach(dd => {
                    dd.classList.remove('show');
                });
            }
        });

        // Initialize on load
        window.addEventListener('load', () => {
            initMarketCharts();
            initSectorCharts();
        });
    </script>
</body>
</html>